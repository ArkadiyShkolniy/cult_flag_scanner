#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/deploy_to_server.sh user@server_ip

if [ -z "$1" ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 user@server_ip"
    echo "–ü—Ä–∏–º–µ—Ä: $0 root@192.168.1.100"
    exit 1
fi

SERVER=$1
REMOTE_DIR="~/projects/invest-python-main/complex_flag_scanner"

echo "=========================================="
echo "üöÄ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ù–ê –°–ï–†–í–ï–†"
echo "=========================================="
echo "–°–µ—Ä–≤–µ—Ä: $SERVER"
echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $REMOTE_DIR"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É..."
if ! ssh -o ConnectTimeout=5 "$SERVER" "echo 'Connected'" > /dev/null 2>&1; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    echo "  - –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å IP –∞–¥—Ä–µ—Å–∞"
    echo "  - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ SSH –∫–ª—é—á–µ–π"
    echo "  - –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞"
    exit 1
fi
echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker
echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
if ! ssh "$SERVER" "command -v docker > /dev/null 2>&1"; then
    echo "‚ö†Ô∏è  Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º:"
    echo "  curl -fsSL https://get.docker.com -o get-docker.sh"
    echo "  sudo sh get-docker.sh"
    exit 1
fi
echo "‚úÖ Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
echo ""

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
echo "3Ô∏è‚É£ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh "$SERVER" "mkdir -p $(dirname $REMOTE_DIR)" 2>/dev/null
echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≥–æ—Ç–æ–≤–∞"
echo ""

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
read -p "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä? (y/N): " copy_files
if [[ $copy_files =~ ^[Yy]$ ]]; then
    echo "4Ô∏è‚É£ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..."
    rsync -avz --exclude '__pycache__' --exclude '*.pyc' --exclude '.git' \
        -e ssh ./ "$SERVER:$REMOTE_DIR/"
    echo "‚úÖ –§–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
else
    echo "4Ô∏è‚É£ –ü—Ä–æ–ø—É—Å–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –∫–æ–¥ —É–∂–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)"
fi
echo ""

# –ó–∞–ø—É—Å–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "5Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh "$SERVER" "cd $REMOTE_DIR && \
    docker compose down && \
    docker compose build && \
    docker compose up -d && \
    echo '‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã' && \
    docker compose ps"

echo ""
echo "=========================================="
echo "‚úÖ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û"
echo "=========================================="
echo ""
echo "–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  ssh $SERVER 'cd $REMOTE_DIR && docker compose logs -f'"
echo "  ssh $SERVER 'cd $REMOTE_DIR && docker compose ps'"
echo "  ssh $SERVER 'cd $REMOTE_DIR && docker compose restart trading-bot'"
