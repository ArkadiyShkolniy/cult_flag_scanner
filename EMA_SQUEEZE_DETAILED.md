# 📊 Детальное описание условий входа EMA Squeeze

## 🎯 Концепция EMA Squeeze

**EMA Squeeze** — это стратегия входа в позицию, когда цена "зажата" между двумя уровнями:
- **Нижний уровень**: EMA 7 (быстрая экспоненциальная скользящая средняя)
- **Верхний уровень**: Линия 1-3 (линия сопротивления/поддержки паттерна флаг)

Вход происходит в момент, когда цена находится в этой "зоне зажатия" и получает подтверждение направлением свечи.

---

## 🟢 Условия входа для LONG (Бычий паттерн)

### Визуальная схема:

```
Цена
  ↑
  │                    ┌─ T1 (максимум флагштока)
  │                   ╱│
  │                  ╱ │
  │                 ╱  │
  │                ╱   │
  │               ╱    │
  │              ╱     │
  │             ╱      │
  │            ╱       │
  │           ╱        │
  │          ╱         │
  │         ╱          │
  │        ╱           │
  │       ╱            │
  │      ╱             │
  │     ╱              │
  │    ╱               │
  │   ╱                │
  │  ╱                 │
  │ ╱                  │
  │╱───────────────────┼─ Линия 1-3 (сопротивление)
  │                    │
  │                    │ ← ЗОНА ЗАЖАТИЯ (EMA Squeeze)
  │                    │
  │═══════════════════════════════════════════════════════ EMA 7
  │
  │═══════════════════════════════════════════════════════ EMA 14
  │
  └───────────────────────────────────────────────────────→ Время
```

### Условие 1: Проверка тренда (EMA 7 > EMA 14)

**Описание:**
Быстрая EMA (7 периодов) должна быть выше медленной EMA (14 периодов). Это подтверждает восходящий тренд.

**Пример:**
```python
# Текущие значения:
ema7 = 150.50
ema14 = 148.30

# Проверка:
if ema7 <= ema14:  # 150.50 <= 148.30 → False
    return False, "Нет тренда (EMA 7 <= EMA 14)"
# ✅ Условие выполнено: 150.50 > 148.30
```

**Визуально:**
```
EMA 7:  ──────────────── (150.50) ← выше
EMA 14: ──────────────── (148.30) ← ниже
```

**Почему это важно:**
- Восходящий тренд увеличивает вероятность успешного входа в лонг
- Если EMA 7 ниже EMA 14, тренд нисходящий или боковой — вход в лонг рискован

---

### Условие 2: Цена выше EMA 7 (Close > EMA 7)

**Описание:**
Цена закрытия последней свечи должна быть выше быстрой EMA. Это подтверждает, что цена находится в сильном восходящем тренде.

**Пример:**
```python
# Текущие значения:
close_price = 151.20
ema7 = 150.50

# Проверка:
if close_price < ema7:  # 151.20 < 150.50 → False
    return False, "Цена ниже EMA 7"
# ✅ Условие выполнено: 151.20 > 150.50
```

**Визуально:**
```
Цена:   ●─────────────── (151.20) ← выше EMA 7
EMA 7:  ──────────────── (150.50)
EMA 14: ──────────────── (148.30)
```

**Почему это важно:**
- Цена выше EMA 7 означает сильный восходящий импульс
- Если цена ниже EMA 7, тренд слабеет — вход преждевременен

---

### Условие 3: Расчет линии 1-3 (сопротивление)

**Описание:**
Линия 1-3 строится по точкам T1 и T3 паттерна флаг. Это линия сопротивления коррекции.

**Формула расчета:**
```python
def calculate_line_price(start_idx, start_price, end_idx, end_price, current_idx):
    """
    Рассчитывает цену линии в точке current_idx.
    
    slope = (end_price - start_price) / (end_idx - start_idx)
    price = start_price + slope * (current_idx - start_idx)
    """
    if end_idx == start_idx:
        return start_price
    
    slope = (end_price - start_price) / (end_idx - start_idx)
    return start_price + slope * (current_idx - start_idx)
```

**Пример:**
```python
# Координаты паттерна:
t1 = {'idx': 100, 'price': 155.00}  # Точка T1
t3 = {'idx': 120, 'price': 153.50}  # Точка T3
current_idx = 125  # Текущая свеча

# Расчет:
slope = (153.50 - 155.00) / (120 - 100) = -1.50 / 20 = -0.075
line_1_3_price = 155.00 + (-0.075) * (125 - 100)
                = 155.00 + (-0.075) * 25
                = 155.00 - 1.875
                = 153.125

# ✅ Линия 1-3 на текущей свече: 153.125
```

**Визуально:**
```
Цена
  ↑
  │
155│ T1 ●───────────────────────────────
  │    │╲
  │    │ ╲
154│    │  ╲─────────────── Линия 1-3
  │    │   ╲              ╲
  │    │    ╲              ╲
153│    │     ╲              ╲───────● T3
  │    │      ╲              ╲
  │    │       ╲              ╲
152│    │        ╲              ╲
  │    │         ╲              ╲
151│    │          ●───────────────● Текущая цена (151.20)
  │    │
150│    │═══════════════════════════════ EMA 7 (150.50)
  │    │
  └────┴────────────────────────────────→ Время
     100                               125
```

---

### Условие 4: Цена ниже линии 1-3 (Close < линия 1-3)

**Описание:**
Цена должна быть ниже линии сопротивления 1-3. Это означает, что цена находится "внутри" паттерна флаг, еще не пробила сопротивление.

**Пример:**
```python
# Текущие значения:
close_price = 151.20
line_1_3_price = 153.125

# Проверка:
if close_price > line_1_3_price:  # 151.20 > 153.125 → False
    return False, "Цена уже пробила линию 1-3 (поздно для Squeeze входа)"
# ✅ Условие выполнено: 151.20 < 153.125
```

**Визуально:**
```
Цена
  ↑
  │
153│─────────────────────────────── Линия 1-3 (153.125)
  │
  │ ← ЗОНА ЗАЖАТИЯ
  │
152│
  │
151│ ●─────────────────────────────── Текущая цена (151.20)
  │
150│═══════════════════════════════════ EMA 7 (150.50)
  │
  └──────────────────────────────────→ Время
```

**Почему это важно:**
- Если цена уже пробила линию 1-3 вверх, вход "поздно" — паттерн уже отработал
- Вход должен быть пока цена "зажата" между EMA и линией

---

### Условие 5: Зеленая свеча (Close > Open)

**Описание:**
Последняя свеча должна быть зеленой (бычьей) — цена закрытия выше цены открытия. Это подтверждает восходящий импульс.

**Пример:**
```python
# Текущая свеча:
open_price = 150.80
close_price = 151.20

# Проверка:
if close_price <= open_price:  # 151.20 <= 150.80 → False
    return False, "Свеча не зеленая"
# ✅ Условие выполнено: 151.20 > 150.80 (зеленая свеча)
```

**Визуально:**
```
Цена
  ↑
  │
151│    ●─────────────── Close (151.20) ← выше Open
  │   ╱│
  │  ╱ │
  │ ╱  │
150│●   │─────────────── Open (150.80)
  │
  └──────────────────────────────────→ Время
```

**Почему это важно:**
- Зеленая свеча подтверждает, что покупатели контролируют рынок
- Красная свеча может означать начало коррекции — вход рискован

---

### ✅ Полный пример успешного входа LONG

**Исходные данные:**
```python
# Индикаторы:
ema7 = 150.50
ema14 = 148.30

# Текущая свеча:
open_price = 150.80
close_price = 151.20

# Паттерн:
t1 = {'idx': 100, 'price': 155.00}
t3 = {'idx': 120, 'price': 153.50}
current_idx = 125

# Расчет линии 1-3:
line_1_3_price = 153.125
```

**Проверка условий:**
```python
# 1. EMA 7 > EMA 14?
150.50 > 148.30 → ✅ True

# 2. Close > EMA 7?
151.20 > 150.50 → ✅ True

# 3. Close < линия 1-3?
151.20 < 153.125 → ✅ True

# 4. Зеленая свеча?
151.20 > 150.80 → ✅ True
```

**Результат:**
```python
return True, "SIGNAL LONG: Price 151.20 зажата между EMA7 (150.50) и Линией 1-3 (153.125)"
```

**Визуально:**
```
Цена
  ↑
  │
155│ T1 ●───────────────────────────────
  │    │╲
  │    │ ╲
154│    │  ╲─────────────── Линия 1-3 (153.125)
  │    │   ╲              ╲
  │    │    ╲              ╲
153│    │     ╲              ╲───────● T3
  │    │      ╲              ╲
  │    │       ╲              ╲
152│    │        ╲              ╲
  │    │         ╲              ╲
151│    │          ●───────────────● Close (151.20) ✅
  │    │         ╱│
  │    │        ╱ │
150│    │       ●  │─────────────── Open (150.80)
  │    │═══════════════════════════════ EMA 7 (150.50)
  │    │
  └────┴────────────────────────────────→ Время
     100                               125
```

---

## 🔴 Условия входа для SHORT (Медвежий паттерн)

### Визуальная схема:

```
Цена
  ↑
  │═══════════════════════════════════════════════════════ EMA 7
  │
  │                    ← ЗОНА ЗАЖАТИЯ (EMA Squeeze)
  │
  │───────────────────┼─ Линия 1-3 (поддержка)
  │                  ╱│
  │                 ╱ │
  │                ╱  │
  │               ╱   │
  │              ╱    │
  │             ╱     │
  │            ╱      │
  │           ╱       │
  │          ╱        │
  │         ╱         │
  │        ╱          │
  │       ╱           │
  │      ╱            │
  │     ╱             │
  │    ╱              │
  │   ╱               │
  │  ╱                │
  │ ╱─────────────────┼─ T1 (минимум флагштока)
  │
  │═══════════════════════════════════════════════════════ EMA 14
  │
  └───────────────────────────────────────────────────────→ Время
```

### Условие 1: Проверка тренда (EMA 7 < EMA 14)

**Описание:**
Быстрая EMA (7 периодов) должна быть ниже медленной EMA (14 периодов). Это подтверждает нисходящий тренд.

**Пример:**
```python
# Текущие значения:
ema7 = 148.30
ema14 = 150.50

# Проверка:
if ema7 >= ema14:  # 148.30 >= 150.50 → False
    return False, "Нет тренда (EMA 7 >= EMA 14)"
# ✅ Условие выполнено: 148.30 < 150.50
```

**Визуально:**
```
EMA 14: ──────────────── (150.50) ← выше
EMA 7:  ──────────────── (148.30) ← ниже
```

---

### Условие 2: Цена ниже EMA 7 (Close < EMA 7)

**Описание:**
Цена закрытия последней свечи должна быть ниже быстрой EMA. Это подтверждает, что цена находится в сильном нисходящем тренде.

**Пример:**
```python
# Текущие значения:
close_price = 147.80
ema7 = 148.30

# Проверка:
if close_price > ema7:  # 147.80 > 148.30 → False
    return False, "Цена выше EMA 7"
# ✅ Условие выполнено: 147.80 < 148.30
```

**Визуально:**
```
EMA 14: ──────────────── (150.50)
EMA 7:  ──────────────── (148.30)
Цена:   ●─────────────── (147.80) ← ниже EMA 7
```

---

### Условие 3: Расчет линии 1-3 (поддержка)

**Описание:**
Линия 1-3 строится по точкам T1 и T3 паттерна флаг. Для медвежьего паттерна это линия поддержки коррекции.

**Пример:**
```python
# Координаты паттерна:
t1 = {'idx': 100, 'price': 145.00}  # Точка T1 (минимум)
t3 = {'idx': 120, 'price': 146.50}  # Точка T3
current_idx = 125  # Текущая свеча

# Расчет:
slope = (146.50 - 145.00) / (120 - 100) = 1.50 / 20 = 0.075
line_1_3_price = 145.00 + 0.075 * (125 - 100)
                = 145.00 + 0.075 * 25
                = 145.00 + 1.875
                = 146.875

# ✅ Линия 1-3 на текущей свече: 146.875
```

**Визуально:**
```
Цена
  ↑
  │
150│═══════════════════════════════════ EMA 14 (150.50)
  │
149│═══════════════════════════════════ EMA 7 (148.30)
  │
148│
  │
147│ ●─────────────────────────────── Текущая цена (147.80)
  │  ╲              ╱
  │   ╲            ╱
146│    ╲──────────╱───────────────● T3
  │     ╲        ╱
  │      ╲      ╱─────────────── Линия 1-3 (146.875)
  │       ╲    ╱
  │        ╲  ╱
145│         ╲╱───────────────● T1
  │
  └──────────────────────────────────→ Время
     100                               125
```

---

### Условие 4: Цена выше линии 1-3 (Close > линия 1-3)

**Описание:**
Цена должна быть выше линии поддержки 1-3. Это означает, что цена находится "внутри" паттерна флаг, еще не пробила поддержку.

**Пример:**
```python
# Текущие значения:
close_price = 147.80
line_1_3_price = 146.875

# Проверка:
if close_price < line_1_3_price:  # 147.80 < 146.875 → False
    return False, "Цена уже пробила линию 1-3 вниз"
# ✅ Условие выполнено: 147.80 > 146.875
```

**Визуально:**
```
Цена
  ↑
  │
148│═══════════════════════════════════ EMA 7 (148.30)
  │
  │ ← ЗОНА ЗАЖАТИЯ
  │
147│ ●─────────────────────────────── Текущая цена (147.80)
  │
146│─────────────────────────────── Линия 1-3 (146.875)
  │
  └──────────────────────────────────→ Время
```

---

### Условие 5: Красная свеча (Close < Open)

**Описание:**
Последняя свеча должна быть красной (медвежьей) — цена закрытия ниже цены открытия. Это подтверждает нисходящий импульс.

**Пример:**
```python
# Текущая свеча:
open_price = 148.20
close_price = 147.80

# Проверка:
if close_price >= open_price:  # 147.80 >= 148.20 → False
    return False, "Свеча не красная"
# ✅ Условие выполнено: 147.80 < 148.20 (красная свеча)
```

**Визуально:**
```
Цена
  ↑
  │
148│●─────────────── Open (148.20)
  │ │╲
  │ │ ╲
  │ │  ╲
  │ │   ╲
147│ │    ●─────────────── Close (147.80) ← ниже Open
  │
  └──────────────────────────────────→ Время
```

---

### ✅ Полный пример успешного входа SHORT

**Исходные данные:**
```python
# Индикаторы:
ema7 = 148.30
ema14 = 150.50

# Текущая свеча:
open_price = 148.20
close_price = 147.80

# Паттерн:
t1 = {'idx': 100, 'price': 145.00}
t3 = {'idx': 120, 'price': 146.50}
current_idx = 125

# Расчет линии 1-3:
line_1_3_price = 146.875
```

**Проверка условий:**
```python
# 1. EMA 7 < EMA 14?
148.30 < 150.50 → ✅ True

# 2. Close < EMA 7?
147.80 < 148.30 → ✅ True

# 3. Close > линия 1-3?
147.80 > 146.875 → ✅ True

# 4. Красная свеча?
147.80 < 148.20 → ✅ True
```

**Результат:**
```python
return True, "SIGNAL SHORT: Price 147.80 зажата между EMA7 (148.30) и Линией 1-3 (146.875)"
```

**Визуально:**
```
Цена
  ↑
  │
150│═══════════════════════════════════ EMA 14 (150.50)
  │
149│
  │
148│●═══════════════════════════════════ EMA 7 (148.30)
  │ │╲
  │ │ ╲
  │ │  ╲
147│ │   ●───────────────────────────── Close (147.80) ✅
  │ │  ╱│
  │ │ ╱ │
146│ │╱  │───────────────────────────── Линия 1-3 (146.875)
  │ │   ╱│
  │ │  ╱ │
145│ │ ╱  │─────────────────────────────● T1
  │ │╱   │
  │ │    │
  └─┴────┴────────────────────────────────→ Время
     100                               125
```

---

## 🚫 Примеры отказа во входе

### Пример 1: Нет тренда (LONG)

```python
ema7 = 148.30
ema14 = 150.50

# Проверка:
if ema7 <= ema14:  # 148.30 <= 150.50 → True
    return False, "Нет тренда (EMA 7 <= EMA 14)"
# ❌ Отказ: EMA 7 ниже EMA 14 — нисходящий тренд
```

### Пример 2: Цена уже пробила линию (LONG)

```python
close_price = 154.00
line_1_3_price = 153.125

# Проверка:
if close_price > line_1_3_price:  # 154.00 > 153.125 → True
    return False, "Цена уже пробила линию 1-3 (поздно для Squeeze входа)"
# ❌ Отказ: Цена уже выше линии — вход поздно
```

### Пример 3: Свеча не подтверждает (LONG)

```python
open_price = 151.20
close_price = 150.80

# Проверка:
if close_price <= open_price:  # 150.80 <= 151.20 → True
    return False, "Свеча не зеленая"
# ❌ Отказ: Красная свеча — нет подтверждения восходящего импульса
```

---

## 📊 Сводная таблица условий

| Условие | LONG | SHORT |
|---------|------|-------|
| **Тренд** | EMA 7 > EMA 14 | EMA 7 < EMA 14 |
| **Положение цены** | Close > EMA 7 | Close < EMA 7 |
| **Зона зажатия** | EMA 7 < Close < Линия 1-3 | Линия 1-3 < Close < EMA 7 |
| **Подтверждение** | Зеленая свеча (Close > Open) | Красная свеча (Close < Open) |

---

## 🎯 Ключевые моменты

1. **"Зажатие"** — цена должна находиться между EMA и линией 1-3
2. **Тренд** — EMA должны быть в правильном порядке для направления входа
3. **Подтверждение** — свеча должна подтверждать направление входа
4. **Своевременность** — вход должен быть до пробития линии 1-3

---

## 💡 Почему эти условия важны?

1. **Тренд (EMA 7 vs EMA 14)** — подтверждает общее направление рынка
2. **Положение цены относительно EMA 7** — показывает силу текущего импульса
3. **Зона зажатия** — оптимальная точка входа с минимальным риском
4. **Подтверждающая свеча** — дополнительная проверка направления движения

Эти условия работают вместе, чтобы минимизировать ложные сигналы и максимизировать вероятность успешного входа.
