# Геометрические ограничения для SHORT (медвежий флаг)

## Правила для точек паттерна:

### T0 - Нет ограничений
Точка T0 не имеет специальных геометрических ограничений.

### T1 - Нет ограничений
Точка T1 не имеет специальных геометрических ограничений.

### T2 - Не выше фиба 0.62 хода T0-T1
**Правило:** T2 <= T1 + 0.62 * (T0 - T1)

Это означает, что первая коррекция (T2) не должна уходить выше уровня коррекции фибоначчи 0.62 от низа T1 вверх.

**Пример:**
- Если T0 = 200, T1 = 100 (ход = 100)
- Коррекция фибоначчи 0.62 от T1 вверх = 100 + 0.62 * 100 = 162
- T2 должна быть <= 162

### T3 - Должна находиться в диапазоне фиба 0.5 хода T1-T2, но не ниже T1
**Правила:**
1. T3 >= T1  (обязательно: не ниже дна флагштока)
2. T3 <= T1 + 0.5 * (T2 - T1)  (не выше уровня фиба 0.5)
   - Это означает, что T3 должна быть в диапазоне между T1 и уровнем фиба 0.5
   - Формула: T1 <= T3 <= 0.5 * (T1 + T2)
   - T3 не должна быть выше фиба 0.5 (не должна быть слишком близко к T2)

**Пример:**
- Если T1 = 100, T2 = 138 (ход T1-T2 = 38)
- Уровень фиба 0.5 = 100 + 0.5 * 38 = 119
- T3 должна быть в диапазоне [100, 119] (не ниже T1, не выше фиба 0.5)
- T3 >= 100 И T3 <= 119

**Пример 2:**
- Если T1 = 100, T2 = 110 (ход T1-T2 = 10)
- Уровень фиба 0.5 = 100 + 0.5 * 10 = 105
- T3 должна быть в диапазоне [100, 105]

**Пример 3:**
- Если T1 = 100, T2 = 105 (ход T1-T2 = 5)
- Уровень фиба 0.5 = 100 + 0.5 * 5 = 102.5
- T3 должна быть в диапазоне [100, 102.5]

### T4 - В диапазоне фиба 0.5 хода T2-T3, но не выше фиба 0.62 хода T0-T1
**Правила:**
1. T4 >= T3 + 0.5 * (T2 - T3)  (не ниже уровня фиба 0.5 от хода T2-T3)
2. T4 <= min(T1 + 0.62 * (T0 - T1), T2)  (не выше уровня фиба 0.62 от флагштока T0-T1 и не выше T2)
   - T4 может быть равна T2, если T2 <= фиба 0.62

**Пример:**
- Если T0 = 200, T1 = 100, T2 = 138, T3 = 115
  - Ход T0-T1 = 100, фиба 0.62 от T1 = 100 + 0.62 * 100 = 162
  - Ход T2-T3 = 138 - 115 = 23
  - Нижняя граница от фиба 0.5: T3 + 0.5 * (T2 - T3) = 115 + 0.5 * 23 = 126.5
  - Верхняя граница: min(162, 138) = 138 (так как T2 = 138 <= фиба 0.62 = 162)
- T4 должна быть в диапазоне [126.5, 138]

### Линии T1-T3 и T2-T4 - Параллельны или сходятся, но не расходятся
**Правило:** Линии тренда T1-T3 и T2-T4 могут быть:
- Параллельны
- Сходиться (сужение флага)
- **НЕ могут расходиться** (расширение флага)

**Реализация:**
- Вычисляем углы наклона линий: `slope_13` и `slope_24`
- Для медвежьего флага обе линии направлены вверх (slope > 0)
- Для схождения: `slope_24` должен быть менее положительным (ближе к 0), чем `slope_13`
- Штраф применяется, если `slope_24 > slope_13 * 1.02` (линии расходятся)

## Визуализация:

```
Цена ↑
  T0 ──────────────────────────┐
     │                          │ Флагшток (T0-T1)
  T2 ────────────┐         T4 ──┤
     │            │             │
  T3 ─────────────┴─────────────┘
     │                          │
  T1 └──────────────────────────┘
     ←──────────────────────────→
              Время

Линии:
  T1 ──── T3  (нижняя линия тренда)
  T2 ──── T4  (верхняя линия тренда)
```

## Погрешности (tolerance):

Погрешности применяются ко всем геометрическим проверкам в зависимости от таймфрейма:
- **5 минут (5m)**: 0.1%
- **1 час (1h)**: 0.3%
- **1 день (1d)**: 0.5%

## Штрафы в loss функции:

1. **T2 > фиба 0.62**: Штраф 2.0x (сильный)
2. **T3 > max_t3_from_t2**: Штраф 1.5x
3. **T3 < T1**: Штраф 1.5x
4. **T4 < min_t4_from_t3**: Штраф 1.5x
5. **T4 > max_t4_from_pole**: Штраф 2.0x (сильный)
6. **Расхождение линий**: Штраф 1.0x

