# –ü–æ—á–µ–º—É –Ω–∞—Ä—É—à–∞–µ—Ç—Å—è –≥–µ–æ–º–µ—Ç—Ä–∏—è —Ñ–∏–≥—É—Ä?

## ‚ùì –í–æ–ø—Ä–æ—Å
–ü–æ—á–µ–º—É –º–æ–¥–µ–ª—å –Ω–∞—Ä—É—à–∞–µ—Ç –≥–µ–æ–º–µ—Ç—Ä–∏—é, —Ö–æ—Ç—è –ø—Ä–∏ —Ä–∞–∑–º–µ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –≥–µ–æ–º–µ—Ç—Ä–∏—è —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è –Ω–∞ 100%?

## üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

### 1. Loss —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞

**–¢–µ–∫—É—â–∏–π loss:**
```python
keypoint_loss = MSELoss(pred_keypoints, true_keypoints)
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- MSE –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ (x, y)
- –ú–æ–¥–µ–ª—å –Ω–µ "–∑–Ω–∞–µ—Ç", —á—Ç–æ —Ç–æ—á–∫–∏ —Å–≤—è–∑–∞–Ω—ã –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏
- –ù–∞–ø—Ä–∏–º–µ—Ä, –º–æ–¥–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ:
  - T4 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ T0 (–¥–ª—è –±—ã—á—å–µ–≥–æ/–º–µ–¥–≤–µ–∂—å–µ–≥–æ)
  - T2 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–∂–¥—É T0 –∏ T1 (–¥–ª—è –±—ã—á—å–µ–≥–æ)
  - T4 –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–≤—ã—à–∞—Ç—å 50% –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä:**
```
–†–µ–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: T0.y=100, T4.y=105 (–ø—Ä–∞–≤–∏–ª—å–Ω–æ: T4 > T0)
–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–æ: T0.y=100, T4.y=95 (–Ω–∞—Ä—É—à–µ–Ω–∏–µ: T4 < T0)

MSE –¥–ª—è T0: (100-100)¬≤ = 0 ‚úÖ
MSE –¥–ª—è T4: (105-95)¬≤ = 100 ‚úÖ
Total MSE = 0 + 100 = 100 (–º–∞–ª–µ–Ω—å–∫–∏–π!)

–ú–æ–¥–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —à—Ç—Ä–∞—Ñ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞!
```

### 2. –ú–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–¥–µ–ª–∏:**
```python
keypoints = fc_keypoint2(features)  # [batch, 10] - 5 —Ç–æ—á–µ–∫ √ó 2 –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
keypoints = keypoints.view(-1, 5, 2)  # [batch, 5, 2]
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–∞–∂–¥–∞—è —Ç–æ—á–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–∑–∞–∏–º–æ—Å–≤—è–∑—è—Ö –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
- –ú–æ–¥–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç –æ –ø–æ—Ä—è–¥–∫–µ –∏ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª–∞—Ö

### 3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç –∏—Å–∫–∞–∂–∞—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—é

**–ü—Ä–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:**
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É [0, 1]
- –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è, –Ω–æ...
- –ï—Å–ª–∏ window_size –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≥–µ–æ–º–µ—Ç—Ä–∏—è –∏—Å–∫–∞–∂–∞–µ—Ç—Å—è
- (–≠—Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç)

### 4. –ú–æ–¥–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∞ –Ω–µ –ø—Ä–∞–≤–∏–ª–∞

**–ß—Ç–æ –≤–∏–¥–∏—Ç –º–æ–¥–µ–ª—å:**
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å–≤–µ—á–µ–π (224√ó224√ó3)
- –ù–µ –∑–Ω–∞–µ—Ç –æ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª–∞—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞ "–§–ª–∞–≥"
- –£—á–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ –ø–æ—Ö–æ–∂–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω
- –ù–æ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –ù–∞–ø—Ä–∏–º–µ—Ä, –º–æ–∂–µ—Ç –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å "—Ñ–ª–∞–≥" –≥–¥–µ T4 < T0, –µ—Å–ª–∏ —ç—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω–æ –ø–æ—Ö–æ–∂–µ

### 5. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –≥–µ–æ–º–µ—Ç—Ä–∏–∏

**–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**
- 107 —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã–º –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–º –ø—Ä–∞–≤–∏–ª–∞–º
- –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–æ–±—É—á–∏—Ç—å—Å—è –Ω–∞ –¥–µ—Ç–∞–ª–∏, –∞ –Ω–µ –Ω–∞ –æ–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å constraint –Ω–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—é –≤ loss —Ñ—É–Ω–∫—Ü–∏—é

### –ü–æ–¥—Ö–æ–¥ 1: Penalty –∑–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è

–î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —à—Ç—Ä–∞—Ñ—ã –≤ loss:
```python
geometry_penalty = 0.0

# –î–ª—è –±—ã—á—å–µ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
if pattern_type == 'bullish':
    # T4 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ T0
    if pred_t4_y < pred_t0_y:
        geometry_penalty += (pred_t0_y - pred_t4_y) * penalty_weight
    
    # T4 –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–≤—ã—à–∞—Ç—å 50% –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
    pole_height = abs(pred_t1_y - pred_t0_y)
    max_t4 = pred_t0_y + pole_height * 0.5
    if pred_t4_y > max_t4:
        geometry_penalty += (pred_t4_y - max_t4) * penalty_weight
    
    # T2 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–∂–¥—É T0 –∏ T1
    if not (pred_t0_y <= pred_t2_y <= pred_t1_y):
        geometry_penalty += violation_penalty * penalty_weight

# –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –º–µ–¥–≤–µ–∂—å–µ–≥–æ

total_loss = mse_loss + geometry_penalty
```

### –ü–æ–¥—Ö–æ–¥ 2: Relative coordinates –≤–º–µ—Å—Ç–æ absolute

–í–º–µ—Å—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ:
```python
# –í–º–µ—Å—Ç–æ: T0.x, T0.y, T1.x, T1.y, ...
# –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å: T0.x, T0.y, (T1-T0), (T2-T1), (T3-T2), (T4-T3)
```

–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ—Ä—è–¥–æ–∫, –Ω–æ –Ω–µ –≤—Å–µ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞.

### –ü–æ–¥—Ö–æ–¥ 3: Multi-task learning —Å –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏

–î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã—Ö–æ–¥—ã –º–æ–¥–µ–ª–∏:
```python
# –û—Å–Ω–æ–≤–Ω–æ–π –≤—ã—Ö–æ–¥: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–µ–∫
keypoints = model(images)  # [batch, 5, 2]

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã—Ö–æ–¥—ã: –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏
geometry_features = geometry_head(features)  # [batch, N]
# –ù–∞–ø—Ä–∏–º–µ—Ä: pole_height, correction_depth, angle_13, angle_24, etc.

# Loss –¥–ª—è –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
geometry_loss = MSELoss(pred_geometry, true_geometry)

# –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π loss
total_loss = keypoint_loss + geometry_loss
```

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ**: –î–æ–±–∞–≤–∏—Ç—å penalty –∑–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –≤ loss —Ñ—É–Ω–∫—Ü–∏—é
2. **–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—É—á–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
3. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ**: –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (relative coordinates, multi-task learning)

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è constraint

- –ì–µ–æ–º–µ—Ç—Ä–∏—è –±—É–¥–µ—Ç —Å–æ–±–ª—é–¥–∞—Ç—å—Å—è –≤ >80% —Å–ª—É—á–∞–µ–≤
- –ú–æ–¥–µ–ª—å –±—É–¥–µ—Ç "–∑–Ω–∞—Ç—å" –æ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª–∞—Ö
- –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –±—É–¥—É—Ç –±–æ–ª–µ–µ –≤–∞–ª–∏–¥–Ω—ã–º–∏

