# –ü–æ—á–µ–º—É –Ω–∞—Ä—É—à–∞–µ—Ç—Å—è –≥–µ–æ–º–µ—Ç—Ä–∏—è —Ñ–∏–≥—É—Ä?

## ‚úÖ –í—ã —Å–æ–±–ª—é–¥–∞–µ—Ç–µ –≥–µ–æ–º–µ—Ç—Ä–∏—é –ø—Ä–∏ —Ä–∞–∑–º–µ—Ç–∫–µ

–î–∞, –≤ –≤–∞—à–∏—Ö —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≥–µ–æ–º–µ—Ç—Ä–∏—è —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è. –ü—Ä–æ–±–ª–µ–º–∞ **–ù–ï –≤ –¥–∞–Ω–Ω—ã—Ö**, –∞ –≤ —Ç–æ–º, **–∫–∞–∫ –º–æ–¥–µ–ª—å —É—á–∏—Ç—Å—è**.

## ‚ùå –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: Loss —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞

### –¢–µ–∫—É—â–∏–π loss (—Ç–æ–ª—å–∫–æ MSE):

```python
keypoint_loss = MSELoss(pred_keypoints, true_keypoints)
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç MSE:**
- –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ** –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏
- –î–ª—è T0: `(pred_t0_x - true_t0_x)¬≤ + (pred_t0_y - true_t0_y)¬≤`
- –î–ª—è T1: `(pred_t1_x - true_t1_x)¬≤ + (pred_t1_y - true_t1_y)¬≤`
- –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Loss –¥–ª—è T0 **–Ω–µ –∑–∞–≤–∏—Å–∏—Ç** –æ—Ç T1, T2, T3, T4
- Loss –¥–ª—è T4 **–Ω–µ –∑–Ω–∞–µ—Ç**, —á—Ç–æ T4 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ T0
- –ú–æ–¥–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç **—à—Ç—Ä–∞—Ñ** –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª!

### –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:

```
–†–ï–ê–õ–¨–ù–´–ï –ö–û–û–†–î–ò–ù–ê–¢–´ (–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –≥–µ–æ–º–µ—Ç—Ä–∏—è):
T0: (x=0.2, y=0.3)
T1: (x=0.4, y=0.7)  # –†–æ—Å—Ç –æ—Ç T0 –∫ T1
T2: (x=0.5, y=0.5)  # –ö–æ—Ä—Ä–µ–∫—Ü–∏—è (–º–µ–∂–¥—É T0 –∏ T1)
T3: (x=0.6, y=0.65) # –†–æ—Å—Ç (–≤—ã—à–µ T2)
T4: (x=0.7, y=0.55) # –ö–æ—Ä—Ä–µ–∫—Ü–∏—è (–Ω–æ –≤—ã—à–µ T0 ‚úÖ)

–ü–†–ï–î–°–ö–ê–ó–ê–ù–ò–ï –ú–û–î–ï–õ–ò (–Ω–∞—Ä—É—à–µ–Ω–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—è):
T0: (x=0.2, y=0.3)  ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
T1: (x=0.4, y=0.7)  ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
T2: (x=0.5, y=0.25) ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–Ω–∏–∂–µ T0, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–∂–¥—É T0 –∏ T1)
T3: (x=0.6, y=0.65) ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
T4: (x=0.7, y=0.25) ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–Ω–∏–∂–µ T0, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ T0)

MSE LOSS:
T0: (0.2-0.2)¬≤ + (0.3-0.3)¬≤ = 0 ‚úÖ
T1: (0.4-0.4)¬≤ + (0.7-0.7)¬≤ = 0 ‚úÖ
T2: (0.5-0.5)¬≤ + (0.5-0.25)¬≤ = 0.0625 ‚ùå
T3: (0.6-0.6)¬≤ + (0.65-0.65)¬≤ = 0 ‚úÖ
T4: (0.7-0.7)¬≤ + (0.55-0.25)¬≤ = 0.09 ‚ùå

Total MSE = 0 + 0 + 0.0625 + 0 + 0.09 = 0.1525

–ú–æ–¥–µ–ª—å –ø–æ–ª—É—á–∏–ª–∞ –º–∞–ª–µ–Ω—å–∫–∏–π loss, –ù–û –≥–µ–æ–º–µ—Ç—Ä–∏—è –Ω–∞—Ä—É—à–µ–Ω–∞!
–ú–æ–¥–µ–ª—å –ù–ï –ó–ù–ê–ï–¢, —á—Ç–æ T4 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ T0!
```

## üîç –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?

### 1. –ú–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```python
keypoints = fc_keypoint2(features)  # [batch, 10]
keypoints = keypoints.view(-1, 5, 2)  # [batch, 5, 2]
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–∞–∂–¥–∞—è —Ç–æ—á–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ**
- –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–º, —á—Ç–æ —Ç–æ—á–∫–∏ —Å–≤—è–∑–∞–Ω—ã –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏
- –ú–æ–¥–µ–ª—å –Ω–µ "–∑–Ω–∞–µ—Ç", —á—Ç–æ T4 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ T0

### 2. Loss —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –∏–º–µ–µ—Ç constraint –Ω–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—é

**–¢–µ–∫—É—â–∏–π loss:**
```python
loss = classification_loss + keypoint_loss
```

**–ß—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- ‚ùå Penalty –∑–∞ T4 < T0
- ‚ùå Penalty –∑–∞ T4 –ø—Ä–µ–≤—ã—à–∞–µ—Ç 50% –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
- ‚ùå Penalty –∑–∞ T2 –≤–Ω–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
- ‚ùå Penalty –∑–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –ª–∏–Ω–∏–π —Å–æ —Å–≤–µ—á–∞–º–∏
- ‚ùå Penalty –∑–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –ª–∏–Ω–∏–π

### 3. –ú–æ–¥–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∞ –Ω–µ –ø—Ä–∞–≤–∏–ª–∞

**–ß—Ç–æ –≤–∏–¥–∏—Ç –º–æ–¥–µ–ª—å:**
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ (224√ó224√ó3)
- –£–∑–æ—Ä—ã –∏ —Ñ–æ—Ä–º—ã –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
- **–ù–ï –∑–Ω–∞–µ—Ç** –æ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª–∞—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞ "–§–ª–∞–≥"

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ –ø–æ—Ö–æ–∂–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω
- –ù–æ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ T4 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ T0
- –ú–æ–∂–µ—Ç –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å "—Ñ–ª–∞–≥", –≥–¥–µ –≥–µ–æ–º–µ—Ç—Ä–∏—è –Ω–∞—Ä—É—à–µ–Ω–∞, –µ—Å–ª–∏ —ç—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω–æ –ø–æ—Ö–æ–∂–µ

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å constraint –Ω–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—é –≤ loss —Ñ—É–Ω–∫—Ü–∏—é

### –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

```python
def _compute_geometry_penalty(self, pred_keypoints, labels):
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç penalty –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª
    """
    penalty = 0.0
    
    # –ë–µ—Ä–µ–º Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (—Ü–µ–Ω—ã)
    y_coords = pred_keypoints[:, :, 1]  # [batch, 5]
    
    for i in range(len(y_coords)):
        label = labels[i].item()
        
        if label == 1:  # –ë—ã—á–∏–π —Ñ–ª–∞–≥
            t0_y = y_coords[i, 0]
            t1_y = y_coords[i, 1]
            t2_y = y_coords[i, 2]
            t4_y = y_coords[i, 4]
            
            # T4 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ T0
            if t4_y < t0_y:
                penalty += (t0_y - t4_y) * 2.0  # –®—Ç—Ä–∞—Ñ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ
            
            # T2 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–∂–¥—É T0 –∏ T1
            if not (t0_y <= t2_y <= t1_y):
                penalty += 1.0  # –®—Ç—Ä–∞—Ñ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ
            
            # T4 –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–≤—ã—à–∞—Ç—å 50% –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
            pole_height = abs(t1_y - t0_y)
            max_t4 = t0_y + pole_height * 0.5
            if t4_y > max_t4:
                penalty += (t4_y - max_t4) * 2.0
        
        elif label == 2:  # –ú–µ–¥–≤–µ–∂–∏–π —Ñ–ª–∞–≥
            # –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –º–µ–¥–≤–µ–∂—å–µ–≥–æ
            
    return penalty / len(y_coords)
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ loss:

```python
# MSE loss
mse_loss = MSELoss(pred_keypoints * mask, true_keypoints * mask)

# Order penalty (—É–∂–µ –µ—Å—Ç—å)
order_penalty = self._compute_order_penalty(pred_keypoints, mask)

# Geometry penalty (–ù–û–í–û–ï!)
geometry_penalty = self._compute_geometry_penalty(pred_keypoints, labels)

# –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π loss
keypoint_loss = (mse_loss + 
                self.order_penalty_weight * order_penalty +
                self.geometry_penalty_weight * geometry_penalty)  # –ù–û–í–û–ï!
```

## üéØ –í—ã–≤–æ–¥

**–ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö** - –≥–µ–æ–º–µ—Ç—Ä–∏—è –≤ —Ä–∞–∑–º–µ—Ç–∫–µ —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è.

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ:**
1. Loss —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞
2. –ú–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ—á–∫–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
3. –ú–æ–¥–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —à—Ç—Ä–∞—Ñ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å constraint –Ω–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—é –≤ loss —Ñ—É–Ω–∫—Ü–∏—é
- –ú–æ–¥–µ–ª—å –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å —à—Ç—Ä–∞—Ñ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è
- –ü–æ—Å–ª–µ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è –≥–µ–æ–º–µ—Ç—Ä–∏—è –±—É–¥–µ—Ç —Å–æ–±–ª—é–¥–∞—Ç—å—Å—è

