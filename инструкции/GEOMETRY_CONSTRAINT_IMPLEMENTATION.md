# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è constraint –Ω–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—é –≤ loss —Ñ—É–Ω–∫—Ü–∏—é

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

### 1. –ú–µ—Ç–æ–¥ `_compute_geometry_penalty()`

–ú–µ—Ç–æ–¥ —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏ –≤—Å–µ—Ö 5 —Ç–æ—á–µ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞:

#### –î–ª—è –±—ã—á—å–µ–≥–æ —Ñ–ª–∞–≥–∞:
- **–ü—Ä–∞–≤–∏–ª–æ 1**: T4 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ T0 (–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–µ –¥–æ–ª–∂–Ω–∞ —É—Ö–æ–¥–∏—Ç—å –Ω–∏–∂–µ –Ω–∞—á–∞–ª–∞ —Ä–æ—Å—Ç–∞)
- **–ü—Ä–∞–≤–∏–ª–æ 2**: T2 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–∂–¥—É T0 –∏ T1 –ø–æ —Ü–µ–Ω–µ (–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –ø–æ—Å–ª–µ —Ä–æ—Å—Ç–∞)
- **–ü—Ä–∞–≤–∏–ª–æ 3**: T3 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å >= T1 * 0.95 (—Ä–æ—Å—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è)
- **–ü—Ä–∞–≤–∏–ª–æ 4**: T4 –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–≤—ã—à–∞—Ç—å T0 + 50% —Ñ–ª–∞–≥—à—Ç–æ–∫–∞ (–≤—Ç–æ—Ä–æ–π –æ—Ç–∫–∞—Ç –Ω–µ –±–æ–ª–µ–µ 50%)
- **–ü—Ä–∞–≤–∏–ª–æ 5**: –õ–∏–Ω–∏–∏ T1-T3 –∏ T2-T4 –Ω–µ –¥–æ–ª–∂–Ω—ã —Ä–∞—Å—Ö–æ–¥–∏—Ç—å—Å—è

#### –î–ª—è –º–µ–¥–≤–µ–∂—å–µ–≥–æ —Ñ–ª–∞–≥–∞:
- **–ü—Ä–∞–≤–∏–ª–æ 1**: T4 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ T0 (–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –≤–≤–µ—Ä—Ö –ø–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è)
- **–ü—Ä–∞–≤–∏–ª–æ 2**: T2 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–∂–¥—É T1 –∏ T3 –ø–æ —Ü–µ–Ω–µ (–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –ø–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è)
- **–ü—Ä–∞–≤–∏–ª–æ 3**: T3 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å <= T1 * 1.05 (–ø–∞–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è)
- **–ü—Ä–∞–≤–∏–ª–æ 4**: T4 –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∏–∂–µ T0 - 50% —Ñ–ª–∞–≥—à—Ç–æ–∫–∞ (–≤—Ç–æ—Ä–æ–π –æ—Ç–∫–∞—Ç –Ω–µ –±–æ–ª–µ–µ 50%)
- **–ü—Ä–∞–≤–∏–ª–æ 5**: –õ–∏–Ω–∏–∏ T1-T3 –∏ T2-T4 –Ω–µ –¥–æ–ª–∂–Ω—ã —Ä–∞—Å—Ö–æ–¥–∏—Ç—å—Å—è

#### –û–±—â–µ–µ –ø—Ä–∞–≤–∏–ª–æ:
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Ñ–ª–∞–≥—à—Ç–æ–∫–∞ (–¥–ª—è –æ–±–æ–∏—Ö —Ç–∏–ø–æ–≤)

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ loss —Ñ—É–Ω–∫—Ü–∏—é

```python
# MSE loss –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
mse_loss = MSELoss(pred_keypoints * mask, true_keypoints * mask)

# Penalty –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ —Ç–æ—á–µ–∫
order_penalty = _compute_order_penalty(pred_keypoints, mask)

# Penalty –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª (–ù–û–í–û–ï!)
geometry_penalty = _compute_geometry_penalty(pred_keypoints, labels, mask)

# –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π keypoint loss
keypoint_loss = (mse_loss + 
                order_penalty_weight * order_penalty +
                geometry_penalty_weight * geometry_penalty)  # –ù–û–í–û–ï!
```

### 3. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

- `geometry_penalty_weight`: –í–µ—Å –¥–ª—è penalty –∑–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0.5)
- –ú–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å, —É—Å—Ç–∞–Ω–æ–≤–∏–≤ –≤ 0.0

### 4. –ú–µ—Ç—Ä–∏–∫–∏

- `train_geometry_penalties`: –°–ø–∏—Å–æ–∫ geometry penalty –¥–ª—è –∫–∞–∂–¥–æ–π —ç–ø–æ—Ö–∏ –æ–±—É—á–µ–Ω–∏—è
- `val_geometry_penalties`: –°–ø–∏—Å–æ–∫ geometry penalty –¥–ª—è –∫–∞–∂–¥–æ–π —ç–ø–æ—Ö–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –ª–æ–≥–∞—Ö –æ–±—É—á–µ–Ω–∏—è

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–∏–º–µ—Ä:

```
–ë–´–ß–ò–ô –ü–ê–¢–¢–ï–†–ù:

–†–µ–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –≥–µ–æ–º–µ—Ç—Ä–∏—è):
T0.y = 0.3
T1.y = 0.7  (—Ä–æ—Å—Ç –æ—Ç T0 –∫ T1)
T2.y = 0.5  (–∫–æ—Ä—Ä–µ–∫—Ü–∏—è, –º–µ–∂–¥—É T0 –∏ T1) ‚úÖ
T3.y = 0.65 (—Ä–æ—Å—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è) ‚úÖ
T4.y = 0.55 (–∫–æ—Ä—Ä–µ–∫—Ü–∏—è, –Ω–æ –≤—ã—à–µ T0) ‚úÖ

–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ (–Ω–∞—Ä—É—à–µ–Ω–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—è):
T0.y = 0.3
T1.y = 0.7
T2.y = 0.25 ‚ùå (–Ω–∏–∂–µ T0, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–∂–¥—É T0 –∏ T1)
T3.y = 0.65
T4.y = 0.25 ‚ùå (–Ω–∏–∂–µ T0, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ)

MSE Loss: –º–∞–ª–µ–Ω—å–∫–∏–π (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±–ª–∏–∑–∫–∏ –∫ —Ä–µ–∞–ª—å–Ω—ã–º)
Order Penalty: 0.0 ‚úÖ (–ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)
Geometry Penalty: > 0.0 ‚ùå (–µ—Å—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è!)

Total Loss = MSE + Order + Geometry
–ú–æ–¥–µ–ª—å –ø–æ–ª—É—á–∏—Ç —à—Ç—Ä–∞—Ñ –∑–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è!
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ constraint:
- ‚ùå –ì–µ–æ–º–µ—Ç—Ä–∏—è –Ω–∞—Ä—É—à–µ–Ω–∞ –≤ 100% –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- ‚ùå T4 < T0 –≤ 45% —Å–ª—É—á–∞–µ–≤
- ‚ùå T2 –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –≤ 75% —Å–ª—É—á–∞–µ–≤
- ‚ùå T4 –ø—Ä–µ–≤—ã—à–∞–µ—Ç 50% –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –≤ 80% —Å–ª—É—á–∞–µ–≤

### –ü–æ—Å–ª–µ constraint:
- ‚úÖ –ì–µ–æ–º–µ—Ç—Ä–∏—è –±—É–¥–µ—Ç —Å–æ–±–ª—é–¥–∞—Ç—å—Å—è –≤ >80% —Å–ª—É—á–∞–µ–≤
- ‚úÖ T4 –≤—Å–µ–≥–¥–∞ –≤—ã—à–µ T0
- ‚úÖ T2 –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
- ‚úÖ T4 –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 50% –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏:

```bash
python neural_network/train_keypoints.py \
    --geometry_penalty_weight 0.5 \
    --order_penalty_weight 0.5 \
    --epochs 100 \
    --batch_size 8
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–µ—Å–æ–≤:

- `geometry_penalty_weight = 0.0` - –æ—Ç–∫–ª—é—á–µ–Ω–æ
- `geometry_penalty_weight = 0.3` - –º—è–≥–∫–∏–π constraint (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –Ω–∞—á–∞–ª–∞)
- `geometry_penalty_weight = 0.5` - —Å—Ä–µ–¥–Ω–∏–π constraint (**—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**)
- `geometry_penalty_weight = 1.0` - –∂–µ—Å—Ç–∫–∏–π constraint (–º–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ)

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°–ª–µ–¥–∏—Ç–µ –∑–∞ –º–µ—Ç—Ä–∏–∫–æ–π `Geometry` –≤ –ª–æ–≥–∞—Ö –æ–±—É—á–µ–Ω–∏—è:
```
Epoch 1/100:
  Train Loss: 0.1234 (Cls: 0.0456, KP: 0.0778, Order: 0.0012, Geometry: 0.0156) | Acc: 85.50%
```

–ï—Å–ª–∏ `Geometry` —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è ‚Üí –º–æ–¥–µ–ª—å —É—á–∏—Ç—Å—è —Å–æ–±–ª—é–¥–∞—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—é ‚úÖ
–ï—Å–ª–∏ `Geometry` –æ—Å—Ç–∞–µ—Ç—Å—è –≤—ã—Å–æ–∫–∏–º ‚Üí –≤–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ:
- –£–≤–µ–ª–∏—á–∏—Ç—å `geometry_penalty_weight`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—É—á–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
- –£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–æ—Ö –æ–±—É—á–µ–Ω–∏—è

## üí° –í–∞–∂–Ω–æ

1. **–ú–æ–¥–µ–ª—å —Ç–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏ –≤—Å–µ—Ö 5 —Ç–æ—á–µ–∫**
2. **–í—Å–µ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**
3. **–®—Ç—Ä–∞—Ñ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª–µ–Ω —Å—Ç–µ–ø–µ–Ω–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è**
4. **–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤ —Å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º (label > 0)**

## üìÅ –§–∞–π–ª—ã

- `trainer_keypoints.py` - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è constraint
- `train_keypoints.py` - —Å–∫—Ä–∏–ø—Ç –æ–±—É—á–µ–Ω–∏—è —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `--geometry_penalty_weight`
- `GEOMETRY_CONSTRAINT_IMPLEMENTATION.md` - —ç—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

