# –ü–æ—á–µ–º—É –Ω–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫ - –û–ë–™–Ø–°–ù–ï–ù–ò–ï

## üéØ –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å: "–ü–æ—á–µ–º—É —Å–µ—Ç—å –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫? –Ø –∂–µ –ø—Ä–∏ —Ä–∞–∑–º–µ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å–æ–±–ª—é–¥–∞—é –µ–≥–æ"

## ‚úÖ –í—ã —Å–æ–±–ª—é–¥–∞–µ—Ç–µ –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∏ —Ä–∞–∑–º–µ—Ç–∫–µ

–î–∞, –≤ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑–º–µ—Ç–∫–∏ –ø–æ—Ä—è–¥–æ–∫ **—Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è**:
- T0 < T1 < T2 < T3 < T4 (–ø–æ –∏–Ω–¥–µ–∫—Å—É —Å–≤–µ—á–∏)
- 103 –∏–∑ 107 –ø—Ä–∏–º–µ—Ä–æ–≤ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å (96.3%)

## ‚ùå –ù–æ –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Ä—è–¥–æ–∫ —Ç–µ—Ä—è–µ—Ç—Å—è!

### –ü—Ä–æ–±–ª–µ–º–∞ #1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (–ò–°–ü–†–ê–í–õ–ï–ù–û)

**–ë—ã–ª–æ**:
```python
# –í _candles_to_image: —Å–æ–∑–¥–∞–µ—Ç—Å—è df_plot –¥–ª–∏–Ω–æ–π 52 —Å–≤–µ—á–∏
# –í _load_keypoints: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è self.window = 100
x_norm = (candle_idx - window_start) / self.window  # ‚ùå –î–µ–ª–µ–Ω–∏–µ –Ω–∞ 100 –≤–º–µ—Å—Ç–æ 52!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
- T0 (idx=23): x_norm = 23/100 = 0.23
- T4 (idx=32): x_norm = 32/100 = 0.32
- –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, **–ù–û** –µ—Å–ª–∏ –≤—Å–µ —Ç–æ—á–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ –¥–∞–Ω–Ω—ã—Ö (idx 150-165 –ø—Ä–∏ window=100), –æ–Ω–∏ –≤—Å–µ –ø–æ–ª—É—á–∞—Ç x_norm –±–ª–∏–∑–∫–∏–π –∫ 1.0

**–°—Ç–∞–ª–æ** (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):
```python
window_size = normalization_params.get('window_size', self.window)  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É
x_norm = (candle_idx - window_start) / (window_size - 1)  # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
```

### –ü—Ä–æ–±–ª–µ–º–∞ #2: –¢–æ—á–∫–∏ –≤–Ω–µ –æ–∫–Ω–∞ –ø–æ–ª—É—á–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã

–ö–æ–≥–¥–∞ `_candles_to_image` –±–µ—Ä–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ `window` —Å–≤–µ—á–µ–π:
- Window start = len(df) - window
- –ï—Å–ª–∏ —Ç–æ—á–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –î–û window_start, –æ–Ω–∞ –ø–æ–ª—É—á–∞–µ—Ç x_norm = 0.0 (–ø–æ—Å–ª–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)
- –ï—Å–ª–∏ —Ç–æ—á–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ü–û–°–õ–ï window_end, –æ–Ω–∞ –ø–æ–ª—É—á–∞–µ—Ç x_norm = 1.0

**–ü—Ä–∏–º–µ—Ä**:
- –î–∞–Ω–Ω—ã—Ö: 240 —Å–≤–µ—á–µ–π
- Window: 100
- –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–≤–µ—á–µ–π (–∏–Ω–¥–µ–∫—Å—ã 140-239)
- –¢–æ—á–∫–∏: T0=17, T1=33 (–æ–±–µ –î–û –æ–∫–Ω–∞!)
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: –æ–±–µ –ø–æ–ª—É—á–∞—é—Ç x_norm = 0.0
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ—Ä—è–¥–æ–∫ —Ç–µ—Ä—è–µ—Ç—Å—è!

### –ü—Ä–æ–±–ª–µ–º–∞ #3: –ú–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–¥–µ–ª–∏:
```python
keypoints = fc_keypoint2(features)  # [batch, 10]
keypoints = keypoints.view(-1, 5, 2)  # [batch, 5, 2]
```

–ö–∞–∂–¥–∞—è —Ç–æ—á–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ**, –º–æ–¥–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ:
- T0.x –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å < T1.x
- T1.x –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å < T2.x
- –ò —Ç.–¥.

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å T2 –ø–µ—Ä–µ–¥ T1, –∏ loss –±—É–¥–µ—Ç —Ç–∞–∫–æ–π –∂–µ!

### –ü—Ä–æ–±–ª–µ–º–∞ #4: Loss —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫

```python
keypoint_loss = MSELoss(pred_keypoints, true_keypoints)
```

MSE Loss –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è **–ø–æ–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ**:
- Loss –¥–ª—è T0.x –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç T1.x
- Loss –¥–ª—è T1.x –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç T0.x
- –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –ø–µ—Ä–µ–ø—É—Ç–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫, –Ω–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±–ª–∏–∑–∫–∏, loss –±—É–¥–µ—Ç –º–∞–ª–µ–Ω—å–∫–∏–º

**–ü—Ä–∏–º–µ—Ä**:
- –†–µ–∞–ª—å–Ω–æ: T0.x=0.2, T1.x=0.3, T2.x=0.4
- –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–æ: T0.x=0.3, T1.x=0.2, T2.x=0.4 (–ø–æ—Ä—è–¥–æ–∫ –Ω–∞—Ä—É—à–µ–Ω!)
- MSE = (0.3-0.2)¬≤ + (0.2-0.3)¬≤ + (0.4-0.4)¬≤ = 0.01 + 0.01 + 0 = 0.02
- **Loss –º–∞–ª–µ–Ω—å–∫–∏–π, –Ω–æ –ø–æ—Ä—è–¥–æ–∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π!**

## üîç –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?

### 1. –ú–æ–¥–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç –æ "—Ç–æ—á–∫–∞—Ö" –∫–∞–∫ –æ —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–î–ª—è –º–æ–¥–µ–ª–∏:
- T0, T1, T2, T3, T4 - —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ 5 –ø–∞—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (x, y)
- –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–º, —á—Ç–æ —ç—Ç–æ —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ù–µ—Ç constraint –Ω–∞ —Ç–æ, —á—Ç–æ T0.x < T1.x < T2.x < T3.x < T4.x

### 2. –í –æ–±—É—á–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Ä—è–¥–æ–∫ "—Å–∫—Ä—ã—Ç" –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö

–•–æ—Ç—è –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Ä—è–¥–æ–∫ –µ—Å—Ç—å (T0=129 < T1=140 < ...), –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:
- –ï—Å–ª–∏ –≤—Å–µ —Ç–æ—á–∫–∏ –≤ –∫–æ–Ω—Ü–µ –æ–∫–Ω–∞ ‚Üí –≤—Å–µ x_norm ‚âà 1.0
- –ü–æ—Ä—è–¥–æ–∫ **—Ç–µ—Ä—è–µ—Ç—Å—è** –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
- –ú–æ–¥–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –µ–≥–æ –≤—ã—É—á–∏—Ç—å

### 3. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞

- –í—Å–µ–≥–æ 104 –ø—Ä–∏–º–µ—Ä–∞
- –ò–∑ –Ω–∏—Ö –º–Ω–æ–≥–∏–µ –∏–º–µ—é—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π
- –ú–æ–¥–µ–ª—å –Ω–µ–¥–æ–æ–±—É—á–µ–Ω–∞

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `window_size` –≤ `normalization_params`
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ–∫–Ω–∞
3. ‚úÖ –§–æ—Ä–º—É–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞: `x_norm = (idx - window_start) / (window_size - 1)`

## üìã –ß—Ç–æ –µ—â–µ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

1. **–î–æ–±–∞–≤–∏—Ç—å constraint –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ –≤ loss —Ñ—É–Ω–∫—Ü–∏—é**
2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å —Ç–æ—á–∫–∞–º–∏ –≤–Ω–µ –æ–∫–Ω–∞** (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, –∞ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ window)
3. **–î–æ–±–∞–≤–∏—Ç—å penalty –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞** –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏
4. **–ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å** —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π

## üéØ –í—ã–≤–æ–¥

**–ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ —Ç–æ–º, —á—Ç–æ –≤—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–∑–º–µ—á–∞–µ—Ç–µ –¥–∞–Ω–Ω—ã–µ.**

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ:**
1. –ü—Ä–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–æ—Ä—è–¥–æ–∫ —Ç–µ—Ä—è–µ—Ç—Å—è (–∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ window_size)
2. –ú–æ–¥–µ–ª—å –Ω–µ –∏–º–µ–µ—Ç constraint –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫
3. Loss —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –º–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∞—Ç—å —É—á–∏—Ç—ã–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫!

