# –ü–æ—á–µ–º—É –Ω–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫

## üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

–•–æ—Ç—è –ø—Ä–∏ —Ä–∞–∑–º–µ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫ T0 < T1 < T2 < T3 < T4 —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è, –Ω–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å –Ω–µ –º–æ–∂–µ—Ç –µ–≥–æ –≤—ã—É—á–∏—Ç—å –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–∏—á–∏–Ω–∞–º:

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ #1: –í—Å–µ —Ç–æ—á–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É

### –ü—Ä–∏—á–∏–Ω–∞:
–í —Ñ—É–Ω–∫—Ü–∏–∏ `_candles_to_image` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∞—è –ª–æ–≥–∏–∫–∞:
- –ï—Å–ª–∏ `len(df) > window`: –±–µ—Ä–µ–º **–ø–æ—Å–ª–µ–¥–Ω–∏–µ** `window` —Å–≤–µ—á–µ–π
- –ï—Å–ª–∏ `len(df) <= window`: –±–µ—Ä–µ–º **–≤—Å–µ** —Å–≤–µ—á–∏

### –ü—Ä–æ–±–ª–µ–º–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –≤ –¥–≤—É—Ö —Å–ª—É—á–∞—è—Ö:

#### –°–ª—É—á–∞–π –ê: –ö–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –º–µ–Ω—å—à–µ window
**–ü—Ä–∏–º–µ—Ä**: 
- –î–∞–Ω–Ω—ã—Ö: 52 —Å–≤–µ—á–∏
- Window: 100
- –ë–µ—Ä–µ–º –≤—Å–µ 52 —Å–≤–µ—á–∏, `window_start = 0`
- –ò–Ω–¥–µ–∫—Å—ã —Ç–æ—á–µ–∫: T0=23, T1=26, T2=27, T3=30, T4=32
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: `x_norm = idx / 100` (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –î–æ–ª–∂–Ω–æ –±—ã—Ç—å `idx / 52`)

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –í—Å–µ —Ç–æ—á–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –º–∞–ª–µ–Ω—å–∫–∏–µ X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –Ω–æ –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è. –û–¥–Ω–∞–∫–æ –µ—Å–ª–∏ –≤—Å–µ —Ç–æ—á–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–Ω–¥–µ–∫—Å—ã 150-165 –ø—Ä–∏ window=100), –æ–Ω–∏ –≤—Å–µ –ø–æ–ª—É—á–∞—Ç x_norm=1.0.

#### –°–ª—É—á–∞–π –ë: –ö–æ–≥–¥–∞ —Ç–æ—á–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤–Ω–µ –æ–∫–Ω–∞
**–ü—Ä–∏–º–µ—Ä**:
- –î–∞–Ω–Ω—ã—Ö: 240 —Å–≤–µ—á–µ–π
- Window: 100
- –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–≤–µ—á–µ–π (–∏–Ω–¥–µ–∫—Å—ã 140-239)
- Window start: 140
- –ò–Ω–¥–µ–∫—Å—ã —Ç–æ—á–µ–∫: T0=17, T1=33 (–Ω–∞—Ö–æ–¥—è—Ç—Å—è –î–û –Ω–∞—á–∞–ª–∞ –æ–∫–Ω–∞!)
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: `x_norm = (17 - 140) / 100 = -1.23`, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 0.0
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –í—Å–µ —Ç–æ—á–∫–∏ –≤–Ω–µ –æ–∫–Ω–∞ –ø–æ–ª—É—á–∞—é—Ç x_norm=0.0 –∏–ª–∏ x_norm=1.0

### –ü—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:

1. **–í—Å–µ X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã = 1.0** (–∫–æ–≥–¥–∞ —Ç–æ—á–∫–∏ –≤ –∫–æ–Ω—Ü–µ –æ–∫–Ω–∞):
   ```
   –î–∞–Ω–Ω—ã—Ö: 189 —Å–≤–µ—á–µ–π, window=100
   –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–≤–µ—á–µ–π (–∏–Ω–¥–µ–∫—Å—ã 89-188)
   –¢–æ—á–∫–∏: T0=129, T1=140, T2=154, T3=163, T4=165
   –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: –≤—Å–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [89-188], –Ω–æ...
   –í–û–¢ –ü–†–û–ë–õ–ï–ú–ê: –µ—Å–ª–∏ –≤ _load_keypoints –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è self.window=100, 
   –∞ –Ω–µ —Ä–µ–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ df_plot, —Ç–æ:
   x_norm = (idx - window_start) / self.window = (idx - 89) / 100
   T0: (129-89)/100 = 0.40 ‚úÖ
   T4: (165-89)/100 = 0.76 ‚úÖ
   –ù–æ –µ—Å–ª–∏ window_start –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ...
   ```

2. **–ü—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ**:
   –í `_load_keypoints`:
   ```python
   x_norm = (candle_idx - window_start) / self.window  # ‚ùå –ü–†–û–ë–õ–ï–ú–ê!
   ```
   
   –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   ```python
   x_norm = (candle_idx - window_start) / len(df_plot)  # ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
   ```
   
   **–ü–æ—á–µ–º—É**: –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –º–µ–Ω—å—à–µ window, –º—ã –±–µ—Ä–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, –Ω–æ –¥–µ–ª–∏–º –Ω–∞ self.window=100, —á—Ç–æ –¥–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é!

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ #2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ self.window –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã –æ–∫–Ω–∞

–í `_load_keypoints` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `self.window` (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ 100), –Ω–æ:
- –ü—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏: `_candles_to_image` –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å `df_plot` —Å –¥–ª–∏–Ω–æ–π –º–µ–Ω—å—à–µ window
- –ü—Ä–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–∏: `_candles_to_image` –ø–æ–ª—É—á–∞–µ—Ç `df_window` —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª–∏–Ω–æ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–Ω—ã—Ö –º–∞—Å—à—Ç–∞–±–æ–≤!

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ #3: Loss —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫

MSE Loss –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏:
```python
keypoint_loss = MSELoss(pred_keypoints, true_keypoints)
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
- –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å T2 –ø–µ—Ä–µ–¥ T1, –∏ loss –±—É–¥–µ—Ç —Ç–∞–∫–æ–π –∂–µ, –∫–∞–∫ –µ—Å–ª–∏ –±—ã –ø–æ—Ä—è–¥–æ–∫ –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –ù–µ—Ç constraint –Ω–∞ —Ç–æ, —á—Ç–æ T0.x < T1.x < T2.x < T3.x < T4.x

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ #4: –ú–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–¥–µ–ª–∏:
```python
keypoints = fc_keypoint2(keypoint_features)  # [batch, 10]
keypoints = keypoints.view(-1, 5, 2)  # [batch, 5, 2]
```

–ö–∞–∂–¥–∞—è —Ç–æ—á–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ, –±–µ–∑ —É—á–µ—Ç–∞ —Ç–æ–≥–æ, —á—Ç–æ:
- T0.x –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ T1.x
- T1.x –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ T2.x
- –ò —Ç.–¥.

## üí° –†–µ—à–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é (–ö–†–ò–¢–ò–ß–ù–û!)
```python
def _load_keypoints(self, row, df, normalization_params):
    window_start = normalization_params.get('window_start', 0)
    window_size = normalization_params.get('window_size', self.window)  # ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É
    
    x_norm = (candle_idx - window_start) / window_size  # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
```

### 2. –î–æ–±–∞–≤–∏—Ç—å constraint –≤ loss —Ñ—É–Ω–∫—Ü–∏—é
```python
# –î–æ–±–∞–≤–∏—Ç—å penalty –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞
order_penalty = 0.0
for i in range(4):
    if pred_keypoints[0, i, 0] >= pred_keypoints[0, i+1, 0]:
        order_penalty += 1.0  # –®—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫

keypoint_loss = MSE_loss + order_penalty_weight * order_penalty
```

### 3. –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –º–æ–¥–µ–ª–∏
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å relative coordinates –≤–º–µ—Å—Ç–æ absolute:
- T0: –∞–±—Å–æ–ª—é—Ç–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
- T1: —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç T0 (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0)
- T2: —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç T1 (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0)
- –ò —Ç.–¥.

### 4. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å window_size –≤ normalization_params
–í `_candles_to_image` –¥–æ–±–∞–≤–∏—Ç—å `window_size` –≤ normalization_params:
```python
normalization_params = {
    'price_min': price_min,
    'price_max': price_max,
    'window_start': window_start,
    'window_size': len(df_plot)  # ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É
}
```

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

1. **–í–´–°–û–ö–ò–ô**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é (window_size –≤–º–µ—Å—Ç–æ self.window)
2. **–í–´–°–û–ö–ò–ô**: –î–æ–±–∞–≤–∏—Ç—å window_size –≤ normalization_params
3. **–°–†–ï–î–ù–ò–ô**: –î–æ–±–∞–≤–∏—Ç—å constraint –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ –≤ loss —Ñ—É–Ω–∫—Ü–∏—é
4. **–ù–ò–ó–ö–ò–ô**: –ò–∑–º–µ–Ω–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –º–æ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

- –ú–æ–¥–µ–ª—å —Å–º–æ–∂–µ—Ç –≤—ã—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫
- X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±—É–¥—É—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç—Ä–∞–∂–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –≤ –æ–∫–Ω–µ
- –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –±—É–¥—É—Ç –∏–º–µ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å T0 < T1 < T2 < T3 < T4

