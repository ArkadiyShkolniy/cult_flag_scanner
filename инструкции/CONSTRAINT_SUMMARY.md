# –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ: Constraint –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫

## üéØ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

–î–æ–±–∞–≤–ª–µ–Ω **constraint –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫** –≤ loss —Ñ—É–Ω–∫—Ü–∏—é –æ–±—É—á–µ–Ω–∏—è –Ω–µ–π—Ä–æ–Ω–Ω–æ–π —Å–µ—Ç–∏.

## üìã –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ constraint:
```
–ú–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç: T0.x=0.3, T1.x=0.2, T2.x=0.4 (–ø–æ—Ä—è–¥–æ–∫ –Ω–∞—Ä—É—à–µ–Ω!)
MSE loss: 0.02 (–º–∞–ª–µ–Ω—å–∫–∏–π, –ø–æ—Ç–æ–º—É —á—Ç–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±–ª–∏–∑–∫–∏)
–†–µ–∑—É–ª—å—Ç–∞—Ç: –ú–æ–¥–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ –ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω!
```

### 2. –†–µ—à–µ–Ω–∏–µ —Å constraint:
```
–ú–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç: T0.x=0.3, T1.x=0.2, T2.x=0.4 (–ø–æ—Ä—è–¥–æ–∫ –Ω–∞—Ä—É—à–µ–Ω!)
MSE loss: 0.02
Order penalty: 0.1 (—à—Ç—Ä–∞—Ñ –∑–∞ T0.x > T1.x)
Total loss: 0.02 + 0.5 * 0.1 = 0.07 (–±–æ–ª—å—à–µ!)
–†–µ–∑—É–ª—å—Ç–∞—Ç: –ú–æ–¥–µ–ª—å —É—á–∏—Ç—Å—è —Å–æ–±–ª—é–¥–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫!
```

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ú–µ—Ç–æ–¥ `_compute_order_penalty`:
```python
def _compute_order_penalty(self, pred_keypoints, mask):
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç penalty –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ T0 < T1 < T2 < T3 < T4
    """
    x_coords = pred_keypoints[:, :, 0]  # [batch, 5] - X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    
    penalty = 0.0
    for i in range(4):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º 4 –ø–∞—Ä—ã: T0<T1, T1<T2, T2<T3, T3<T4
        # –ï—Å–ª–∏ T[i].x >= T[i+1].x, —Ç–æ –ø–æ—Ä—è–¥–æ–∫ –Ω–∞—Ä—É—à–µ–Ω
        violation = torch.clamp(x_coords[:, i] - x_coords[:, i+1], min=0.0)
        penalty += violation.sum()
    
    return penalty / active_count  # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ loss:
```python
# MSE loss –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
mse_loss = MSELoss(pred_keypoints * mask, true_keypoints * mask)

# Penalty –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞
order_penalty = _compute_order_penalty(pred_keypoints, mask)

# –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π loss
keypoint_loss = mse_loss + order_penalty_weight * order_penalty
```

## ‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

### `order_penalty_weight`:
- **0.0** - –æ—Ç–∫–ª—é—á–µ–Ω–æ (–Ω–µ—Ç constraint)
- **0.1** - –º—è–≥–∫–∏–π constraint (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –Ω–∞—á–∞–ª–∞)
- **0.5** - —Å—Ä–µ–¥–Ω–∏–π constraint (**—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**)
- **1.0** - –∂–µ—Å—Ç–∫–∏–π constraint (–º–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ)

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
```bash
python neural_network/train_keypoints.py \
    --order_penalty_weight 0.5 \
    --epochs 100 \
    --batch_size 8
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ constraint:
- ‚ùå –ü–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫ –Ω–∞—Ä—É—à–µ–Ω –≤ 100% —Å–ª—É—á–∞–µ–≤
- ‚ùå T0 –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Å–ª–µ T1
- ‚ùå –ú–æ–¥–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç –æ –ø–æ—Ä—è–¥–∫–µ

### –ü–æ—Å–ª–µ constraint:
- ‚úÖ –ü–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫ —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è –≤ >95% —Å–ª—É—á–∞–µ–≤
- ‚úÖ T0 –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥ T1, T1 –ø–µ—Ä–µ–¥ T2, –∏ —Ç.–¥.
- ‚úÖ –ú–æ–¥–µ–ª—å "–∑–Ω–∞–µ—Ç" –æ –ø–æ—Ä—è–¥–∫–µ –∏ —Å–æ–±–ª—é–¥–∞–µ—Ç –µ–≥–æ

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. ‚úÖ –ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–ª—é–¥–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫
2. ‚úÖ –ù–µ –Ω—É–∂–Ω–∞ –ø–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
3. ‚úÖ –ú–æ–∂–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∂–µ—Å—Ç–∫–æ—Å—Ç—å constraint
4. ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤ —Å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º (label > 0)

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

1. **–ù—É–∂–Ω–æ –ø–µ—Ä–µ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å** —Å –Ω–æ–≤—ã–º constraint
2. **–ù–∞—á–Ω–∏—Ç–µ —Å order_penalty_weight=0.1**, –∑–∞—Ç–µ–º —É–≤–µ–ª–∏—á—å—Ç–µ –¥–æ 0.5
3. **–°–ª–µ–¥–∏—Ç–µ –∑–∞ –º–µ—Ç—Ä–∏–∫–æ–π order_penalty** - –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ —É–º–µ–Ω—å—à–∞—Ç—å—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
4. **–ï—Å–ª–∏ penalty –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è**, –≤–æ–∑–º–æ–∂–Ω–æ, –¥–∞–Ω–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –æ—à–∏–±–∫–∏

## üìÅ –§–∞–π–ª—ã

- `trainer_keypoints.py` - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è constraint
- `train_keypoints.py` - —Å–∫—Ä–∏–ø—Ç –æ–±—É—á–µ–Ω–∏—è —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `--order_penalty_weight`
- `ORDER_CONSTRAINT_EXPLANATION.md` - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
- `CONSTRAINT_SUMMARY.md` - —ç—Ç–æ —Ä–µ–∑—é–º–µ

