# Геометрические ограничения для LONG (бычий флаг)

## Правила для точек паттерна:

### T0 - Нет ограничений
Точка T0 не имеет специальных геометрических ограничений.

### T1 - Нет ограничений
Точка T1 не имеет специальных геометрических ограничений.

### T2 - Не ниже фиба 0.62 хода T0-T1
**Правило:** T2 >= T1 - 0.62 * (T1 - T0)

Это означает, что первая коррекция (T2) не должна уходить ниже уровня коррекции фибоначчи 0.62 от вершины T1 вниз.

**Пример:**
- Если T0 = 100, T1 = 200 (ход = 100)
- Коррекция фибоначчи 0.62 от T1 вниз = 200 - 0.62 * 100 = 138
- T2 должна быть >= 138

### T3 - Должна находиться в диапазоне фиба 0.5 хода T1-T2, но не выше T1
**Правила:**
1. T3 >= T2 + 0.5 * (T1 - T2)  (не ниже уровня фиба 0.5)
2. T3 <= T1  (не выше вершины флагштока)
   - Это означает, что T3 должна быть в диапазоне между уровнем фиба 0.5 и T1
   - Формула: T2 + 0.5 * (T1 - T2) <= T3 <= T1
   - T3 не должна быть ниже фиба 0.5 (не должна быть слишком близко к T2)

**Пример:**
- Если T1 = 200, T2 = 180 (ход T1-T2 = 20)
- Уровень фиба 0.5 = 180 + 0.5 * 20 = 190
- T3 должна быть в диапазоне [190, 200] (не ниже фиба 0.5, не выше T1)
- T3 >= 190 И T3 <= 200

### T4 - В диапазоне фиба 0.5 хода T2-T3, но не ниже фиба 0.62 хода T0-T1
**Правила:**
1. T4 <= T3 - 0.5 * (T3 - T2)  (не выше уровня фиба 0.5 от хода T2-T3)
2. T4 >= max(T1 - 0.62 * (T1 - T0), T2)  (не ниже уровня фиба 0.62 от флагштока T0-T1 и не ниже T2)
   - T4 может быть равна T2, если T2 >= фиба 0.62

**Пример:**
- Если T0 = 100, T1 = 200, T2 = 180, T3 = 195
  - Ход T0-T1 = 100, коррекция фиба 0.62 от T1 = 200 - 0.62 * 100 = 138
  - Ход T2-T3 = 195 - 180 = 15
  - Верхняя граница от фиба 0.5: T3 - 0.5 * (T3 - T2) = 195 - 0.5 * 15 = 187.5
  - Нижняя граница: max(138, 180) = 180 (так как T2 = 180 >= фиба 0.62 = 138)
- T4 должна быть в диапазоне [180, 187.5]

### Линии T1-T3 и T2-T4 - Параллельны или сходятся, но не расходятся
**Правило:** Линии тренда T1-T3 и T2-T4 могут быть:
- Параллельны
- Сходиться (сужение флага)
- **НЕ могут расходиться** (расширение флага)

**Реализация:**
- Вычисляем углы наклона линий: `slope_13` и `slope_24`
- Для бычьего флага обе линии направлены вниз (slope < 0)
- Для схождения: `slope_24` должен быть менее отрицательным (ближе к 0), чем `slope_13`
- Штраф применяется, если `slope_24 < slope_13 * 0.98` (линии расходятся)

## Визуализация:

```
Цена ↑
  T1 ──────────────────────────┐
     │                          │ Флагшток (T0-T1)
     │                          │
     │         T3 ──────┐       │
     │         │         │      │
  T2 ──────────┴─────────┴───T4 │
     │                          │
  T0 └──────────────────────────┘
     ←──────────────────────────→
              Время

Линии:
  T1 ──── T3  (верхняя линия тренда)
  T2 ──── T4  (нижняя линия тренда)
```

## Погрешности (tolerance):

Погрешности применяются ко всем геометрическим проверкам в зависимости от таймфрейма:
- **5 минут (5m)**: 0.1%
- **1 час (1h)**: 0.3%
- **1 день (1d)**: 0.5%

## Штрафы в loss функции:

1. **T2 < фиба 0.62**: Штраф 2.0x (сильный)
2. **T3 < min_t3_from_t2**: Штраф 1.5x
3. **T3 > T1**: Штраф 1.5x
4. **T4 > max_t4_from_t3**: Штраф 1.5x
5. **T4 < min_t4_from_pole**: Штраф 2.0x (сильный)
6. **Расхождение линий**: Штраф 1.0x

