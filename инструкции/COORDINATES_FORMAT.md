# Формат координат при разметке паттернов

## Какие координаты сохраняются

При разметке паттерна через `labeling_dashboard` сохраняются координаты **5 точек** (T0, T1, T2, T3, T4):

### Формат в DataFrame (при разметке):

Каждая точка сохраняется с двумя значениями:
- **`idx`** - индекс свечи в DataFrame (номер строки, начиная с 0)
- **`price`** - цена точки (high или low свечи, в зависимости от типа паттерна)

**Пример структуры точек в `st.session_state.points`:**
```python
{
    'T0': {'idx': 150, 'price': 292.5, 'time': '2025-12-26 10:00:00'},
    'T1': {'idx': 161, 'price': 295.8, 'time': '2025-12-26 11:00:00'},
    'T2': {'idx': 170, 'price': 293.2, 'time': '2025-12-26 12:00:00'},
    'T3': {'idx': 180, 'price': 296.1, 'time': '2025-12-26 13:00:00'},
    'T4': {'idx': 182, 'price': 294.5, 'time': '2025-12-26 13:00:00'}
}
```

### Формат в annotations.csv:

Координаты сохраняются в **10 колонках** (по 2 на каждую точку):

| Колонка | Описание | Пример |
|---------|----------|--------|
| `t0_idx` | Индекс свечи для точки T0 | `150` |
| `t0_price` | Цена точки T0 | `292.5` |
| `t1_idx` | Индекс свечи для точки T1 | `161` |
| `t1_price` | Цена точки T1 | `295.8` |
| `t2_idx` | Индекс свечи для точки T2 | `170` |
| `t2_price` | Цена точки T2 | `293.2` |
| `t3_idx` | Индекс свечи для точки T3 | `180` |
| `t3_price` | Цена точки T3 | `296.1` |
| `t4_idx` | Индекс свечи для точки T4 | `182` |
| `t4_price` | Цена точки T4 | `294.5` |

### Пример записи в annotations.csv:

```csv
file,label,ticker,timeframe,pattern_type,timestamp,notes,t0_idx,t0_price,t1_idx,t1_price,t2_idx,t2_price,t3_idx,t3_price,t4_idx,t4_price
candles/VKCO_1h_20251226_131410.csv,1,VKCO,1h,FLAG_0_1_2_3_4,2025-12-26T13:14:10,Размечено вручную. Тип: bullish,150,292.5,161,295.8,170,293.2,180,296.1,182,294.5
```

---

## Что означают координаты

### `idx` (индекс свечи):
- **Тип:** целое число (int)
- **Диапазон:** от 0 до (количество свечей - 1)
- **Значение:** номер строки в DataFrame со свечами
- **Пример:** `150` означает 151-ю свечу в DataFrame (индексация с 0)

### `price` (цена точки):
- **Тип:** число с плавающей точкой (float)
- **Единицы:** цена инструмента (рубли, доллары, и т.д.)
- **Как определяется:**
  - Для **бычьего паттерна:**
    - T0, T2, T4 → `low` (минимальная цена свечи)
    - T1, T3 → `high` (максимальная цена свечи)
  - Для **медвежьего паттерна:**
    - T0, T2, T4 → `high` (максимальная цена свечи)
    - T1, T3 → `low` (минимальная цена свечи)

---

## Процесс сохранения координат

### 1. Разметка в labeling_dashboard:

Пользователь отмечает точки на графике → сохраняются в `st.session_state.points`:

```python
st.session_state.points['T0'] = {
    'idx': 150,        # Индекс свечи (от пользователя)
    'price': 292.5,    # Автоматически: df.iloc[150]['low'] (для бычьего)
    'time': '2025-12-26 10:00:00'  # Время свечи
}
```

### 2. Передача в annotator:

При нажатии "Сохранить для обучения" координаты передаются в `annotator.annotate_pattern()`:

```python
annotator.annotate_pattern(
    candles_file=candles_file,
    label=label,
    ticker=ticker,
    timeframe=timeframe,
    pattern_type=pattern_info['pattern'],
    notes=notes,
    points=valid_points  # {'T0': {...}, 'T1': {...}, ...}
)
```

### 3. Сохранение в annotations.csv:

В `annotator.annotate_pattern()` координаты извлекаются и сохраняются:

```python
if points:
    for point_name in ['T0', 'T1', 'T2', 'T3', 'T4']:
        if point_name in points and points[point_name]:
            point_data = points[point_name]
            annotation[f'{point_name.lower()}_idx'] = int(point_data['idx'])
            annotation[f'{point_name.lower()}_price'] = float(point_data['price'])
```

---

## Использование координат

### При обучении keypoint detection:

Координаты загружаются из annotations.csv и преобразуются в **нормализованные координаты изображения** (0-1):

```python
# Из data_loader_keypoints.py
x_norm = (candle_idx - window_start) / window_size  # 0-1
y_norm = (point_price - price_min) / price_range    # 0-1
```

**Пример:**
- Исходные координаты: `idx=150, price=292.5`
- Нормализованные: `x_norm=0.5, y_norm=0.3` (относительно изображения 224x224)

### При визуализации:

Координаты используются для отрисовки точек и линий паттерна на графике.

---

## Важные замечания

1. **Порядок точек:** Точки должны быть в хронологическом порядке (T0 < T1 < T2 < T3 < T4 по индексу)

2. **Только для паттернов:** Координаты сохраняются только для примеров с паттернами (label=1 или label=2), не для "нет паттерна" (label=0)

3. **Старые данные:** Примеры, размеченные до добавления keypoint detection, не содержат координаты (колонки будут пустыми)

4. **Нормализация:** При обучении координаты нормализуются относительно изображения (0-1), что позволяет модели работать с разными масштабами цен

---

## Проверка координат

Чтобы проверить, какие координаты сохранены:

```python
import pandas as pd

df = pd.read_csv('neural_network/data/annotations.csv')
print(df[['file', 'label', 't0_idx', 't0_price', 't1_idx', 't1_price']].head())
```

Или через терминал:
```bash
head -5 neural_network/data/annotations.csv | cut -d',' -f1-12
```

